"0","# Create the simulated data"
"0","m <- 50"
"0","n <- 10000"
"0","nc <- 1000 # negative controls without treatment effects"
"0","p <- 1"
"0","k <- 1"
"0","ctl <- rep(FALSE, n)"
"0","ctl[1:nc] <- TRUE"
"0","# treatment effect"
"0","X <- matrix(c(rep(0, floor(m/2)), rep(1, ceiling(m/2))), m, p)"
"0","beta <- matrix(rnorm(p*n, 5, 1), p, n) #treatment coefficients"
"0","beta[ ,ctl] <- 0"
"0","# batch effect"
"0","W <- as.matrix(rep(0, m), m, k)"
"0","W[c(1:12,38:50), 1] <-  1"
"0","alpha <- matrix(rnorm(k*n, 5, 1), k, n)"
"0","Y_alpha <- sapply(alpha, function(alpha){rnorm(m, mean =  alpha, "
"0","                                              abs(rnorm(1, mean = 0, sd = 2)))})"
"0","YY_alpha <- apply(Y_alpha, 2, function(x){x*W})"
"0","epsilon <- matrix(rnorm(m*n, 0, 1), m, n)"
"0","Y <- X%*%beta + YY_alpha + epsilon"
"0","# estimate batch coefficient for each OTU"
"0","w.cof <- c()"
"0","for(i in 1:ncol(Y)){"
"0","  res <- lm(Y[ ,i] ~ X + W)"
"0","  sum.res <- summary(res)"
"0","  w.cof[i] <- sum.res$coefficients[3,1]"
"0","}"
"0","par(mfrow = c(2,2))"
"0","hist(w.cof,col = 'gray')"
