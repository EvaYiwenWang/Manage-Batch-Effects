<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 4 Methods evaluation | Managing Batch Effects in Microbiome Data</title>
  <meta name="description" content="Vignette for paper ‘Managing Batch Effects in Microbiome Data’">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 4 Methods evaluation | Managing Batch Effects in Microbiome Data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Vignette for paper ‘Managing Batch Effects in Microbiome Data’" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Methods evaluation | Managing Batch Effects in Microbiome Data" />
  
  <meta name="twitter:description" content="Vignette for paper ‘Managing Batch Effects in Microbiome Data’" />
  

<meta name="author" content="Yiwen Wang">


<meta name="date" content="2019-06-19">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="adjust.html">
<link rel="next" href="simu.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Batch Effects Management</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Examples of microbiome studies with batch effects</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#study-description"><i class="fa fa-check"></i><b>1.1</b> Study description</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#sponge-aplysina-aerophoba-study"><i class="fa fa-check"></i><b>1.1.1</b> Sponge <em>Aplysina aerophoba</em> study</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#anaerobic-digestion-study"><i class="fa fa-check"></i><b>1.1.2</b> Anaerobic digestion study</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#huntingtons-disease-study"><i class="fa fa-check"></i><b>1.1.3</b> Huntington’s disease study</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-processing"><i class="fa fa-check"></i><b>1.2</b> Data processing</a><ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#prefiltering"><i class="fa fa-check"></i><b>1.2.1</b> Prefiltering</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#total-sum-scaling"><i class="fa fa-check"></i><b>1.2.2</b> Total sum scaling</a></li>
<li class="chapter" data-level="1.2.3" data-path="index.html"><a href="index.html#centered-log-ratio-transformation"><i class="fa fa-check"></i><b>1.2.3</b> Centered log-ratio transformation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="detect.html"><a href="detect.html"><i class="fa fa-check"></i><b>2</b> Batch effect detection</a><ul>
<li class="chapter" data-level="2.1" data-path="detect.html"><a href="detect.html#principal-component-analysis-pca-with-density-plot-per-component"><i class="fa fa-check"></i><b>2.1</b> Principal component analysis (PCA) with density plot per component</a></li>
<li class="chapter" data-level="2.2" data-path="detect.html"><a href="detect.html#density-plot-and-box-plot"><i class="fa fa-check"></i><b>2.2</b> Density plot and box plot</a></li>
<li class="chapter" data-level="2.3" data-path="detect.html"><a href="detect.html#rle-plots"><i class="fa fa-check"></i><b>2.3</b> RLE plots</a></li>
<li class="chapter" data-level="2.4" data-path="detect.html"><a href="detect.html#heatmap"><i class="fa fa-check"></i><b>2.4</b> Heatmap</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="adjust.html"><a href="adjust.html"><i class="fa fa-check"></i><b>3</b> Batch effect adjustment</a><ul>
<li class="chapter" data-level="3.1" data-path="adjust.html"><a href="adjust.html#accounting-for-batch-effects"><i class="fa fa-check"></i><b>3.1</b> Accounting for batch effects</a><ul>
<li class="chapter" data-level="3.1.1" data-path="adjust.html"><a href="adjust.html#linear-model-and-linear-mixed-model"><i class="fa fa-check"></i><b>3.1.1</b> Linear model and linear mixed model</a></li>
<li class="chapter" data-level="3.1.2" data-path="adjust.html"><a href="adjust.html#sva"><i class="fa fa-check"></i><b>3.1.2</b> SVA</a></li>
<li class="chapter" data-level="3.1.3" data-path="adjust.html"><a href="adjust.html#ruv2"><i class="fa fa-check"></i><b>3.1.3</b> RUV2</a></li>
<li class="chapter" data-level="3.1.4" data-path="adjust.html"><a href="adjust.html#ruv4"><i class="fa fa-check"></i><b>3.1.4</b> RUV4</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="adjust.html"><a href="adjust.html#correcting-for-batch-effects"><i class="fa fa-check"></i><b>3.2</b> Correcting for batch effects</a><ul>
<li class="chapter" data-level="3.2.1" data-path="adjust.html"><a href="adjust.html#bmc-batch-mean-centering"><i class="fa fa-check"></i><b>3.2.1</b> BMC (batch mean centering)</a></li>
<li class="chapter" data-level="3.2.2" data-path="adjust.html"><a href="adjust.html#combat"><i class="fa fa-check"></i><b>3.2.2</b> ComBat</a></li>
<li class="chapter" data-level="3.2.3" data-path="adjust.html"><a href="adjust.html#removebatcheffect"><i class="fa fa-check"></i><b>3.2.3</b> removeBatchEffect</a></li>
<li class="chapter" data-level="3.2.4" data-path="adjust.html"><a href="adjust.html#fabatch"><i class="fa fa-check"></i><b>3.2.4</b> FAbatch</a></li>
<li class="chapter" data-level="3.2.5" data-path="adjust.html"><a href="adjust.html#percentile-normalisation"><i class="fa fa-check"></i><b>3.2.5</b> percentile normalisation</a></li>
<li class="chapter" data-level="3.2.6" data-path="adjust.html"><a href="adjust.html#svd-based-method"><i class="fa fa-check"></i><b>3.2.6</b> SVD-based method</a></li>
<li class="chapter" data-level="3.2.7" data-path="adjust.html"><a href="adjust.html#ruviii"><i class="fa fa-check"></i><b>3.2.7</b> RUVIII</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="eval.html"><a href="eval.html"><i class="fa fa-check"></i><b>4</b> Methods evaluation</a><ul>
<li class="chapter" data-level="4.1" data-path="eval.html"><a href="eval.html#diagnostic-plots"><i class="fa fa-check"></i><b>4.1</b> Diagnostic plots</a><ul>
<li class="chapter" data-level="4.1.1" data-path="eval.html"><a href="eval.html#principal-component-analysis-pca-with-density-plot-per-component-1"><i class="fa fa-check"></i><b>4.1.1</b> Principal component analysis (PCA) with density plot per component</a></li>
<li class="chapter" data-level="4.1.2" data-path="eval.html"><a href="eval.html#density-plot-and-box-plot-1"><i class="fa fa-check"></i><b>4.1.2</b> Density plot and box plot</a></li>
<li class="chapter" data-level="4.1.3" data-path="eval.html"><a href="eval.html#rle-plots-1"><i class="fa fa-check"></i><b>4.1.3</b> RLE plots</a></li>
<li class="chapter" data-level="4.1.4" data-path="eval.html"><a href="eval.html#heatmap-1"><i class="fa fa-check"></i><b>4.1.4</b> Heatmap</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="eval.html"><a href="eval.html#variance-calculation"><i class="fa fa-check"></i><b>4.2</b> Variance calculation</a><ul>
<li class="chapter" data-level="4.2.1" data-path="eval.html"><a href="eval.html#linear-model-per-variable"><i class="fa fa-check"></i><b>4.2.1</b> Linear model per variable</a></li>
<li class="chapter" data-level="4.2.2" data-path="eval.html"><a href="eval.html#rda"><i class="fa fa-check"></i><b>4.2.2</b> RDA</a></li>
<li class="chapter" data-level="4.2.3" data-path="eval.html"><a href="eval.html#pvca"><i class="fa fa-check"></i><b>4.2.3</b> PVCA</a></li>
<li class="chapter" data-level="4.2.4" data-path="eval.html"><a href="eval.html#silhouette-coefficient"><i class="fa fa-check"></i><b>4.2.4</b> Silhouette coefficient</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="simu.html"><a href="simu.html"><i class="fa fa-check"></i><b>5</b> Simulations of systematic and non-systematic batch effects</a><ul>
<li class="chapter" data-level="5.1" data-path="simu.html"><a href="simu.html#mean5unequal-variance"><i class="fa fa-check"></i><b>5.1</b> Mean=5,unequal variance</a></li>
<li class="chapter" data-level="5.2" data-path="simu.html"><a href="simu.html#mean05unequal-variance"><i class="fa fa-check"></i><b>5.2</b> Mean=0&amp;5,unequal variance</a></li>
<li class="chapter" data-level="5.3" data-path="simu.html"><a href="simu.html#sponge-data"><i class="fa fa-check"></i><b>5.3</b> Sponge data</a></li>
<li class="chapter" data-level="5.4" data-path="simu.html"><a href="simu.html#ad-data"><i class="fa fa-check"></i><b>5.4</b> AD data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="bibliography.html"><a href="bibliography.html"><i class="fa fa-check"></i>Bibliography</a></li>
<li class="divider"></li>
<li><a href="https://github.com/EvaYiwenWang/vignette" target="blank">Source codes on github</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Managing Batch Effects in Microbiome Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="eval" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Methods evaluation</h1>
<div id="diagnostic-plots" class="section level2">
<h2><span class="header-section-number">4.1</span> Diagnostic plots</h2>
<div id="principal-component-analysis-pca-with-density-plot-per-component-1" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Principal component analysis (PCA) with density plot per component</h3>
<p>We apply PCA on both sponge and AD data before and after correction with different methods.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sponge data</span>
sponge.pca.before =<span class="st"> </span><span class="kw">pca</span>(sponge.tss.clr, <span class="dt">ncomp =</span> <span class="dv">3</span>)
sponge.pca.bmc =<span class="st"> </span><span class="kw">pca</span>(sponge.bmc, <span class="dt">ncomp =</span> <span class="dv">3</span>)
sponge.pca.combat =<span class="st"> </span><span class="kw">pca</span>(sponge.combat, <span class="dt">ncomp =</span> <span class="dv">3</span>)
sponge.pca.limma =<span class="st"> </span><span class="kw">pca</span>(sponge.limma, <span class="dt">ncomp =</span> <span class="dv">3</span>)
sponge.pca.percentile =<span class="st"> </span><span class="kw">pca</span>(sponge.percentile, <span class="dt">ncomp =</span> <span class="dv">3</span>)
sponge.pca.svd =<span class="st"> </span><span class="kw">pca</span>(sponge.svd, <span class="dt">ncomp =</span> <span class="dv">3</span>)

<span class="co"># ad data</span>
ad.pca.before =<span class="st"> </span><span class="kw">pca</span>(ad.tss.clr, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.bmc =<span class="st"> </span><span class="kw">pca</span>(ad.bmc, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.combat =<span class="st"> </span><span class="kw">pca</span>(ad.combat, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.limma =<span class="st"> </span><span class="kw">pca</span>(ad.limma, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.percentile =<span class="st"> </span><span class="kw">pca</span>(ad.percentile, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.svd =<span class="st"> </span><span class="kw">pca</span>(ad.svd, <span class="dt">ncomp =</span> <span class="dv">3</span>)
ad.pca.ruv =<span class="st"> </span><span class="kw">pca</span>(ad.ruvIII, <span class="dt">ncomp =</span> <span class="dv">3</span>)</code></pre></div>
<p>We then plot these PCA sample plots with denisty plots per PC.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.pca.plot.before, sponge.pca.plot.bmc, sponge.pca.plot.combat,sponge.pca.plot.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-42-1.png" width="864" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.pca.plot.before, sponge.pca.plot.percentile,sponge.pca.plot.svd,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-42-2.png" width="864" /></p>
<p>SVD performed the worse, compared to BMC, removeBatchEffect and percentile normalisation, as it did not remove batch effects but removed tissue variation instead.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.pca.plot.before, ad.pca.plot.bmc, ad.pca.plot.combat,ad.pca.plot.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-44-1.png" width="864" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.pca.plot.before, ad.pca.plot.percentile,ad.pca.plot.svd,ad.pca.plot.ruv,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-44-2.png" width="864" /></p>
<p>BMC, removeBatchEffect, percentile normalisation and RUVIII removed the batch effects, and maintained the treatment effects. SVD did not removed the batch effect but decreased the treatment effects.</p>
</div>
<div id="density-plot-and-box-plot-1" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Density plot and box plot</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">###############
## sponge data
sponge.before.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.tss.clr[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.before &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.before.df,<span class="dt">x=</span>sponge.before.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.before.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - before (Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)

sponge.bmc.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.bmc[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.bmc &lt;-<span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.bmc.df,<span class="dt">x=</span>sponge.bmc.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.bmc.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - BMC (Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)


sponge.combat.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.combat[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.combat &lt;-<span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.combat.df,<span class="dt">x=</span>sponge.combat.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.combat.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - ComBat (Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)


sponge.limma.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.limma[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.limma &lt;-<span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.limma.df,<span class="dt">x=</span>sponge.limma.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.limma.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - rBE(Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)

sponge.percentile.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.percentile[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.percentile &lt;-<span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.percentile.df,<span class="dt">x=</span>sponge.percentile.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.percentile.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - PN (Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)

sponge.svd.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> sponge.svd[,<span class="dv">9</span>], <span class="dt">batch =</span> sponge.batch)
sponge.boxplot.svd &lt;-<span class="kw">box_plot_fun</span>(<span class="dt">data =</span> sponge.svd.df,<span class="dt">x=</span>sponge.svd.df<span class="op">$</span>batch,
             <span class="dt">y=</span>sponge.svd.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU9 - SVD (Sponge)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Gel (batch)&#39;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.boxplot.before, sponge.boxplot.bmc, sponge.boxplot.combat, sponge.boxplot.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.boxplot.before, sponge.boxplot.percentile,sponge.boxplot.svd,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-46-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## density plot
<span class="co"># before</span>
sponge.dens.before &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.before.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - before (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())

<span class="co"># BMC</span>
sponge.dens.bmc &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.bmc.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - BMC (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># ComBat</span>
sponge.dens.combat &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.combat.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - ComBat (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># removeBatchEffect </span>
sponge.dens.limma &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.limma.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - rBE (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># percentile normal</span>
sponge.dens.percentile &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.percentile.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - PN (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># SVD</span>
sponge.dens.svd &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sponge.svd.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU9 - SVD (Sponge)&#39;</span>,<span class="dt">x=</span><span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Gel (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.dens.before, sponge.dens.bmc, sponge.dens.combat,sponge.dens.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(sponge.dens.before, sponge.dens.percentile, sponge.dens.svd,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-48-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">######### p-values
sponge.lm.before =<span class="st"> </span><span class="kw">lm</span>(sponge.tss.clr[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.before)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.tss.clr[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.87967 -0.24705  0.04588  0.24492  1.00757 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     1.7849     0.1497  11.922 1.06e-12 ***
## sponge.trtE     0.1065     0.1729   0.616    0.543    
## sponge.batch2  -0.7910     0.1729  -4.575 8.24e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.489 on 29 degrees of freedom
## Multiple R-squared:  0.4236, Adjusted R-squared:  0.3839 
## F-statistic: 10.66 on 2 and 29 DF,  p-value: 0.0003391</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sponge.lm.bmc =<span class="st"> </span><span class="kw">lm</span>(sponge.bmc[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.bmc)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.bmc[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.87967 -0.24705  0.04588  0.24492  1.00757 
## 
## Coefficients:
##                 Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)   -5.323e-02  1.497e-01  -0.356    0.725
## sponge.trtE    1.065e-01  1.729e-01   0.616    0.543
## sponge.batch2  3.925e-17  1.729e-01   0.000    1.000
## 
## Residual standard error: 0.489 on 29 degrees of freedom
## Multiple R-squared:  0.01291,    Adjusted R-squared:  -0.05517 
## F-statistic: 0.1896 on 2 and 29 DF,  p-value: 0.8283</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sponge.lm.combat =<span class="st"> </span><span class="kw">lm</span>(sponge.combat[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.combat)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.combat[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.64583 -0.22414  0.05092  0.24065  0.88585 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    1.46291    0.13491  10.844 1.02e-11 ***
## sponge.trtE    0.09081    0.15578   0.583    0.564    
## sponge.batch2 -0.16201    0.15578  -1.040    0.307    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.4406 on 29 degrees of freedom
## Multiple R-squared:  0.04672,    Adjusted R-squared:  -0.01902 
## F-statistic: 0.7107 on 2 and 29 DF,  p-value: 0.4996</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sponge.lm.limma =<span class="st"> </span><span class="kw">lm</span>(sponge.limma[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.limma)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.limma[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.87967 -0.24705  0.04588  0.24492  1.00757 
## 
## Coefficients:
##                Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   1.389e+00  1.497e-01   9.280 3.49e-10 ***
## sponge.trtE   1.065e-01  1.729e-01   0.616    0.543    
## sponge.batch2 2.355e-16  1.729e-01   0.000    1.000    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.489 on 29 degrees of freedom
## Multiple R-squared:  0.01291,    Adjusted R-squared:  -0.05517 
## F-statistic: 0.1896 on 2 and 29 DF,  p-value: 0.8283</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sponge.lm.percentile =<span class="st"> </span><span class="kw">lm</span>(sponge.percentile[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.percentile)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.percentile[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.4531 -0.2070 -0.0625  0.1797  0.6562 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    0.48438    0.09515   5.090 1.97e-05 ***
## sponge.trtE   -0.17187    0.10987  -1.564    0.129    
## sponge.batch2  0.03125    0.10987   0.284    0.778    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.3108 on 29 degrees of freedom
## Multiple R-squared:  0.08018,    Adjusted R-squared:  0.01674 
## F-statistic: 1.264 on 2 and 29 DF,  p-value: 0.2976</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sponge.lm.svd =<span class="st"> </span><span class="kw">lm</span>(sponge.svd[,<span class="dv">9</span>]<span class="op">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch)
<span class="kw">summary</span>(sponge.lm.svd)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sponge.svd[, 9] ~ sponge.trt + sponge.batch)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.82982 -0.27539  0.05228  0.28204  1.05932 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     1.6433     0.1526  10.766 1.21e-11 ***
## sponge.trtE     0.2817     0.1763   1.598  0.12085    
## sponge.batch2  -0.6831     0.1763  -3.875  0.00056 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.4985 on 29 degrees of freedom
## Multiple R-squared:  0.3773, Adjusted R-squared:  0.3344 
## F-statistic: 8.787 on 2 and 29 DF,  p-value: 0.001039</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##################
<span class="co"># ad data</span>

<span class="co"># boxplot</span>
ad.before.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.tss.clr[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.before &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.before.df,<span class="dt">x=</span>ad.before.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.before.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - before (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)


ad.bmc.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.bmc[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.bmc &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.bmc.df,<span class="dt">x=</span>ad.bmc.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.bmc.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - BMC (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)


ad.combat.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.combat[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.combat &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.combat.df,<span class="dt">x=</span>ad.combat.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.combat.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - ComBat (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)

ad.limma.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.limma[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.limma &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.limma.df,<span class="dt">x=</span>ad.limma.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.limma.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - rBE (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)


ad.percentile.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.percentile[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.percentile &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.percentile.df,<span class="dt">x=</span>ad.percentile.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.percentile.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - PN (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)

ad.svd.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.svd[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.svd &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.svd.df,<span class="dt">x=</span>ad.svd.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.svd.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - SVD (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)

ad.ruv.df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">value =</span> ad.ruvIII[,<span class="dv">1</span>], <span class="dt">batch =</span> ad.batch)

ad.boxplot.ruv &lt;-<span class="st"> </span><span class="kw">box_plot_fun</span>(<span class="dt">data =</span> ad.ruv.df,<span class="dt">x=</span>ad.ruv.df<span class="op">$</span>batch,
             <span class="dt">y=</span>ad.ruv.df<span class="op">$</span>value,<span class="dt">title =</span> <span class="st">&#39;OTU12 - RUVIII (AD)&#39;</span>,
             <span class="dt">batch.legend.title =</span> <span class="st">&#39;Date (batch)&#39;</span>,
             <span class="dt">x.angle =</span> <span class="dv">45</span>, <span class="dt">x.hjust =</span> <span class="dv">1</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.boxplot.before, ad.boxplot.bmc, ad.boxplot.combat, ad.boxplot.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.boxplot.before, ad.boxplot.percentile,ad.boxplot.svd,ad.boxplot.ruv,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-50-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># density plot</span>
<span class="co"># before</span>
ad.dens.before =<span class="st"> </span><span class="kw">ggplot</span>(ad.before.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - before (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())

<span class="co"># BMC</span>
ad.dens.bmc =<span class="st"> </span><span class="kw">ggplot</span>(ad.bmc.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - BMC (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># ComBat</span>
ad.dens.combat =<span class="st"> </span><span class="kw">ggplot</span>(ad.combat.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - ComBat (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># removeBatchEffect</span>
ad.dens.limma =<span class="st"> </span><span class="kw">ggplot</span>(ad.limma.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - rBE (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># percentile norm</span>
ad.dens.percentile =<span class="st"> </span><span class="kw">ggplot</span>(ad.percentile.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - PN (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># SVD</span>
ad.dens.svd =<span class="st"> </span><span class="kw">ggplot</span>(ad.svd.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - SVD (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())


<span class="co"># RUVIII</span>
ad.dens.ruv =<span class="st"> </span><span class="kw">ggplot</span>(ad.ruv.df, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">fill =</span> batch)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">color.mixo</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&#39;OTU12 - RUVIII (AD)&#39;</span>,<span class="dt">x =</span> <span class="st">&#39;Value&#39;</span>,<span class="dt">fill =</span> <span class="st">&#39;Date (batch)&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="fl">0.5</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.dens.before, ad.dens.bmc, ad.dens.combat,ad.dens.limma,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(ad.dens.before, ad.dens.percentile, ad.dens.svd,ad.dens.ruv, <span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-52-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#p-values</span>
ad.lm.before =<span class="st"> </span><span class="kw">lm</span>(ad.tss.clr[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.before)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.tss.clr[, 1]
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## ad.trt     1  1.460  1.4605  3.1001   0.08272 .  
## ad.batch   4 32.889  8.2222 17.4532 6.168e-10 ***
## Residuals 69 32.506  0.4711                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.before)</span>

ad.lm.bmc =<span class="st"> </span><span class="kw">lm</span>(ad.bmc[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.bmc)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.bmc[, 1]
##           Df Sum Sq Mean Sq F value Pr(&gt;F)
## ad.trt     1  0.631 0.63084  1.3391 0.2512
## ad.batch   4  0.036 0.00893  0.0190 0.9993
## Residuals 69 32.506 0.47110</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.bmc)</span>

ad.lm.combat =<span class="st"> </span><span class="kw">lm</span>(ad.combat[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.combat)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.combat[, 1]
##           Df  Sum Sq Mean Sq F value Pr(&gt;F)
## ad.trt     1  0.6695 0.66954  1.6980 0.1969
## ad.batch   4  0.2373 0.05932  0.1504 0.9622
## Residuals 69 27.2080 0.39432</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.combat)</span>

ad.lm.limma =<span class="st"> </span><span class="kw">lm</span>(ad.limma[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.limma)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.limma[, 1]
##           Df Sum Sq Mean Sq F value Pr(&gt;F)
## ad.trt     1  0.704 0.70428   1.495 0.2256
## ad.batch   4  0.000 0.00000   0.000 1.0000
## Residuals 69 32.506 0.47110</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.limma)</span>

ad.lm.percentile =<span class="st"> </span><span class="kw">lm</span>(ad.percentile[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.percentile)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.percentile[, 1]
##           Df Sum Sq Mean Sq F value  Pr(&gt;F)  
## ad.trt     1 0.4670 0.46705  3.8934 0.05248 .
## ad.batch   4 1.7037 0.42592  3.5506 0.01081 *
## Residuals 69 8.2772 0.11996                  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.percentile)</span>

ad.lm.svd =<span class="st"> </span><span class="kw">lm</span>(ad.svd[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.svd)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.svd[, 1]
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## ad.trt     1  0.222  0.2218  0.4841    0.4889    
## ad.batch   4 33.914  8.4784 18.5081 2.256e-10 ***
## Residuals 69 31.608  0.4581                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.svd)</span>


ad.lm.ruv =<span class="st"> </span><span class="kw">lm</span>(ad.ruvIII[,<span class="dv">1</span>]<span class="op">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch)
<span class="kw">anova</span>(ad.lm.ruv)</code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: ad.ruvIII[, 1]
##           Df  Sum Sq Mean Sq F value  Pr(&gt;F)  
## ad.trt     1  2.1333 2.13330  5.4144 0.02291 *
## ad.batch   4  2.0222 0.50554  1.2831 0.28512  
## Residuals 69 27.1862 0.39400                  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summary(ad.lm.ruv)</span></code></pre></div>
</div>
<div id="rle-plots-1" class="section level3">
<h3><span class="header-section-number">4.1.3</span> RLE plots</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sponge data</span>
<span class="co"># before</span>

###### BMC
sponge.bmc_c =<span class="st"> </span>sponge.bmc[sponge.trt <span class="op">==</span><span class="st"> &#39;C&#39;</span>,]
sponge.bmc_e =<span class="st"> </span>sponge.bmc[sponge.trt <span class="op">==</span><span class="st"> &#39;E&#39;</span>,] 

###### ComBat
sponge.combat_c =<span class="st"> </span>sponge.combat[sponge.trt <span class="op">==</span><span class="st"> &#39;C&#39;</span>,]
sponge.combat_e =<span class="st"> </span>sponge.combat[sponge.trt <span class="op">==</span><span class="st"> &#39;E&#39;</span>,] 

###### rBE
sponge.limma_c =<span class="st"> </span>sponge.limma[sponge.trt <span class="op">==</span><span class="st"> &#39;C&#39;</span>,]
sponge.limma_e =<span class="st"> </span>sponge.limma[sponge.trt <span class="op">==</span><span class="st"> &#39;E&#39;</span>,] 

###### PN
sponge.percentile_c =<span class="st"> </span>sponge.percentile[sponge.trt <span class="op">==</span><span class="st"> &#39;C&#39;</span>,]
sponge.percentile_e =<span class="st"> </span>sponge.percentile[sponge.trt <span class="op">==</span><span class="st"> &#39;E&#39;</span>,] 

###### SVD
sponge.svd_c =<span class="st"> </span>sponge.svd[sponge.trt <span class="op">==</span><span class="st"> &#39;C&#39;</span>,]
sponge.svd_e =<span class="st"> </span>sponge.svd[sponge.trt <span class="op">==</span><span class="st"> &#39;E&#39;</span>,] </code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">mai=</span><span class="kw">c</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>))

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.before_c),<span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: before (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.bmc_c), <span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: BMC (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.combat_c),<span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: ComBat (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.limma_c),<span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: rBE (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.percentile_c),<span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: PN (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.svd_c),<span class="dt">batch =</span> sponge.batch_c,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: SVD (choanosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</code></pre></div>
<p>The batch effect before correction is not obvious as all medians of samples are close to zero, but gel2 has a greater interquartile range (IQR) than the other samples. Percentile normalisation increased batch effects, as the samples after correction are deviated from zero and the IQR is increased. Among other methods, the IQR of all the box plots (samples) from different batches is consistent after ComBat correction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">mai=</span><span class="kw">c</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>))

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.before_e),<span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: before (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.bmc_e), <span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: BMC (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.combat_e),<span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: ComBat (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.limma_e),<span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: rBE (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.percentile_e),<span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: PN (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(sponge.svd_e),<span class="dt">batch =</span> sponge.batch_e,<span class="dt">maintitle =</span> <span class="st">&#39;Sponge: SVD (ectosome)&#39;</span>,<span class="dt">title.cex =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-55-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</code></pre></div>
<p>Batch effect is not easily detected, but percentile normalisation increased batch variation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">################
<span class="co"># ad data</span>
<span class="co"># before</span>

###### BMC
ad.bmc_<span class="dv">05</span> =<span class="st"> </span>ad.bmc[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.bmc_<span class="dv">2</span> =<span class="st"> </span>ad.bmc[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]

###### ComBat
ad.combat_<span class="dv">05</span> =<span class="st"> </span>ad.combat[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.combat_<span class="dv">2</span> =<span class="st"> </span>ad.combat[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]

###### rBE
ad.limma_<span class="dv">05</span> =<span class="st"> </span>ad.limma[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.limma_<span class="dv">2</span> =<span class="st"> </span>ad.limma[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]

###### PN
ad.percentile_<span class="dv">05</span> =<span class="st"> </span>ad.percentile[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.percentile_<span class="dv">2</span> =<span class="st"> </span>ad.percentile[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]

###### SVD
ad.svd_<span class="dv">05</span> =<span class="st"> </span>ad.svd[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.svd_<span class="dv">2</span> =<span class="st"> </span>ad.svd[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]

###### RUVIII
ad.ruv_<span class="dv">05</span> =<span class="st"> </span>ad.ruvIII[ad.trt <span class="op">==</span><span class="st"> &#39;0-0.5&#39;</span>,]
ad.ruv_<span class="dv">2</span> =<span class="st"> </span>ad.ruvIII[ad.trt <span class="op">==</span><span class="st"> &#39;1-2&#39;</span>,]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="dt">mai=</span><span class="kw">c</span>(<span class="fl">0.5</span>,<span class="fl">0.8</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>))

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.before_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: before (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.bmc_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: BMC (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.combat_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: ComBat (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.limma_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: rBE (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-57-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.percentile_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: PN (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.svd_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: SVD (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.ruv_<span class="dv">05</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">05</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: RUVIII (0-0.5 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.5</span>)

<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-57-2.png" width="672" /></p>
<p>Batch effect is not easily detected, but percentile normalisation increased batch variation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="dt">mai=</span><span class="kw">c</span>(<span class="fl">0.35</span>,<span class="fl">0.8</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>))

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.before_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: before (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.bmc_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: BMC (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.combat_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: ComBat (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.limma_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: rBE (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.percentile_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: PN (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.svd_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: SVD (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">RleMicroRna2</span>(<span class="dt">object =</span> <span class="kw">t</span>(ad.ruv_<span class="dv">2</span>),<span class="dt">batch =</span> ad.batch_<span class="dv">2</span>,<span class="dt">maintitle =</span> <span class="st">&#39;AD: RUVIII (1-2 g/L)&#39;</span>,<span class="dt">legend.cex =</span> <span class="fl">0.4</span>, <span class="dt">cex.xaxis =</span> <span class="fl">0.3</span>)

<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-58-2.png" width="672" /></p>
<p>Batch effect is not easily detected, but percentile normalisation increased batch variation.</p>
</div>
<div id="heatmap-1" class="section level3">
<h3><span class="header-section-number">4.1.4</span> Heatmap</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Sponge data</span>
<span class="co"># before </span>
sponge.tss.clr.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.tss.clr,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.tss.clr.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.tss.clr.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

sponge.anno_col =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Batch =</span> sponge.batch, <span class="dt">Tissue =</span> sponge.trt)
sponge.anno_metabo_colors =<span class="st"> </span><span class="kw">list</span>(<span class="dt">Batch =</span> <span class="kw">c</span>(<span class="st">&#39;1&#39;</span>=<span class="st">&quot;#388ECC&quot;</span>,<span class="st">&#39;2&#39;</span>=<span class="st">&quot;#F68B33&quot;</span>),<span class="dt">Tissue =</span> <span class="kw">c</span>(<span class="dt">C=</span><span class="st">&quot;#F0E442&quot;</span>,<span class="dt">E=</span><span class="st">&quot;#D55E00&quot;</span>))


<span class="kw">pheatmap</span>(sponge.tss.clr.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors =</span> sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - before&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># BMC </span>
sponge.bmc.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.bmc,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.bmc.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.bmc.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(sponge.bmc.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors=</span>sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - BMC&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ComBat </span>
sponge.combat.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.combat,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.combat.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.combat.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(sponge.combat.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors=</span>sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - ComBat&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-3.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># removeBatchEffect</span>
sponge.limma.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.limma,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.limma.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.limma.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(sponge.limma.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors=</span> sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - removeBatchEffect&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-4.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># percentile normalisation</span>
sponge.percentile.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.percentile,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.percentile.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.percentile.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(sponge.percentile.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors =</span> sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - percentile norm&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-5.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># SVD</span>
sponge.svd.scale =<span class="st"> </span><span class="kw">scale</span>(sponge.svd,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
sponge.svd.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(sponge.svd.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(sponge.svd.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">5</span>, <span class="dt">fontsize_col=</span><span class="dv">8</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> sponge.anno_col,
         <span class="dt">annotation_colors =</span> sponge.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;Sponge data - SVD&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-6.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#################
<span class="co"># AD data</span>
<span class="co"># before </span>
ad.tss.clr.scale =<span class="st"> </span><span class="kw">scale</span>(ad.tss.clr,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.tss.clr.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.tss.clr.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

ad.anno_col =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Batch =</span> ad.batch, <span class="dt">Treatment =</span> ad.trt)
ad.anno_metabo_colors =<span class="st"> </span><span class="kw">list</span>(<span class="dt">Batch =</span> <span class="kw">c</span>(<span class="st">&#39;09/04/2015&#39;</span>=<span class="st">&quot;#388ECC&quot;</span>,<span class="st">&#39;14/04/2016&#39;</span>=<span class="st">&quot;#F68B33&quot;</span>,<span class="st">&#39;01/07/2016&#39;</span>=<span class="st">&quot;#C2C2C2&quot;</span>,<span class="st">&#39;14/11/2016&#39;</span>=<span class="st">&quot;#009E73&quot;</span>,<span class="st">&#39;21/09/2017&#39;</span>=<span class="st">&quot;#CC79A7&quot;</span>), <span class="dt">Treatment =</span> <span class="kw">c</span>(<span class="st">&quot;0-0.5&quot;</span> =<span class="st"> &quot;#0072B2&quot;</span>, <span class="st">&quot;1-2&quot;</span> =<span class="st"> &quot;#999999&quot;</span>))


<span class="kw">pheatmap</span>(ad.tss.clr.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - before&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-7.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># BMC</span>
ad.bmc.scale =<span class="st"> </span><span class="kw">scale</span>(ad.bmc,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.bmc.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.bmc.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.bmc.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - BMC&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-8.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ComBat</span>
ad.combat.scale =<span class="st"> </span><span class="kw">scale</span>(ad.combat,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.combat.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.combat.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.combat.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - ComBat&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-9.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># removeBatchEffect</span>
ad.limma.scale =<span class="st"> </span><span class="kw">scale</span>(ad.limma,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.limma.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.limma.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.limma.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - removeBatchEffect&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-10.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># percentile normalisation</span>
ad.percentile.scale =<span class="st"> </span><span class="kw">scale</span>(ad.percentile,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.percentile.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.percentile.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.percentile.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - percentile norm&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-11.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># SVD</span>
ad.svd.scale =<span class="st"> </span><span class="kw">scale</span>(ad.svd,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.svd.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.svd.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.svd.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - SVD&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-12.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># RUVIII</span>
ad.ruv.scale =<span class="st"> </span><span class="kw">scale</span>(ad.ruvIII,<span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on OTUs</span>
ad.ruv.scale =<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(ad.ruv.scale), <span class="dt">center =</span> T, <span class="dt">scale =</span> T) <span class="co"># scale on samples</span>

<span class="kw">pheatmap</span>(ad.ruv.scale, 
         <span class="dt">scale =</span> <span class="st">&#39;none&#39;</span>, 
         <span class="dt">cluster_rows =</span> F, 
         <span class="dt">cluster_cols =</span> T, 
         <span class="dt">fontsize_row=</span><span class="dv">4</span>, <span class="dt">fontsize_col=</span><span class="dv">6</span>,
         <span class="dt">fontsize =</span> <span class="dv">8</span>,
         <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;euclidean&quot;</span>,
         <span class="dt">clustering_method =</span> <span class="st">&quot;ward.D&quot;</span>,
         <span class="dt">treeheight_row =</span> <span class="dv">30</span>,
         <span class="dt">annotation_col =</span> ad.anno_col,
         <span class="dt">annotation_colors =</span> ad.anno_metabo_colors,
         <span class="dt">border_color =</span> <span class="st">&#39;NA&#39;</span>,
         <span class="dt">main =</span> <span class="st">&#39;AD data - RUVIII&#39;</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-59-13.png" width="672" /></p>
</div>
</div>
<div id="variance-calculation" class="section level2">
<h2><span class="header-section-number">4.2</span> Variance calculation</h2>
<div id="linear-model-per-variable" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Linear model per variable</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Sponge data
form.sponge &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>sponge.trt <span class="op">+</span><span class="st"> </span>sponge.batch
info.sponge =<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(<span class="kw">rownames</span>(sponge.tss.clr),sponge.trt,sponge.batch))
<span class="kw">rownames</span>(info.sponge) =<span class="st"> </span><span class="kw">rownames</span>(sponge.tss.clr)

<span class="co"># before</span>
varPart.sponge.before &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.tss.clr), form.sponge, info.sponge)

<span class="co"># BMC</span>
varPart.sponge.bmc &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.bmc), form.sponge, info.sponge)

<span class="co"># combat</span>
varPart.sponge.combat &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.combat), form.sponge, info.sponge)

<span class="co"># removeBatchEffect</span>
varPart.sponge.limma &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.limma), form.sponge, info.sponge)

<span class="co"># percentile normalisation</span>
varPart.sponge.percentile &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.percentile), form.sponge, info.sponge)

<span class="co"># svd</span>
varPart.sponge.svd &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(sponge.svd), form.sponge, info.sponge)


################
<span class="co">#merge them</span>
variance.sponge =<span class="st">  </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.before<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.before<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.bmc<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.bmc<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.combat<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.combat<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.limma<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.limma<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.percentile<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.percentile<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.svd<span class="op">$</span>sponge.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>,<span class="dv">24</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.sponge.svd<span class="op">$</span>sponge.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Tissue&#39;</span>,<span class="dv">24</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>,<span class="dv">24</span>)))

variance.sponge =<span class="st"> </span><span class="kw">as.data.frame</span>(variance.sponge)
variance.sponge<span class="op">$</span>Type =<span class="st"> </span><span class="kw">factor</span>(variance.sponge<span class="op">$</span>Type,<span class="dt">levels =</span> <span class="kw">unique</span>(variance.sponge<span class="op">$</span>Type))
variance.sponge<span class="op">$</span>method =<span class="st"> </span><span class="kw">factor</span>(variance.sponge<span class="op">$</span>method,<span class="dt">levels =</span> <span class="kw">unique</span>(variance.sponge<span class="op">$</span>method))
variance.sponge<span class="op">$</span>variance =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(variance.sponge<span class="op">$</span>variance))

<span class="kw">ggplot</span>(variance.sponge, <span class="kw">aes</span>(<span class="dt">x=</span>Type, <span class="dt">y=</span>variance,<span class="dt">fill=</span>Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(<span class="dt">cols =</span> <span class="kw">vars</span>(method)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Type&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion Variance&quot;</span>,<span class="dt">name=</span><span class="st">&#39;Type&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-60-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##########
<span class="co"># AD data</span>
form.ad &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>ad.trt <span class="op">+</span><span class="st"> </span>ad.batch
info.ad =<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(<span class="kw">rownames</span>(ad.tss.clr),ad.trt,ad.batch))
<span class="kw">rownames</span>(info.ad) =<span class="st"> </span><span class="kw">rownames</span>(ad.tss.clr)

<span class="co"># before</span>
varPart.ad.before &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.tss.clr), form.ad, info.ad)

<span class="co"># BMC</span>
varPart.ad.bmc &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.bmc), form.ad, info.ad)

<span class="co"># combat</span>
varPart.ad.combat &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.combat), form.ad, info.ad)

<span class="co"># removeBatchEffect</span>
varPart.ad.limma &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.limma), form.ad, info.ad)

<span class="co"># percentile normalisation</span>
varPart.ad.percentile &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.percentile), form.ad, info.ad)

<span class="co"># svd</span>
varPart.ad.svd &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.svd), form.ad, info.ad)

<span class="co"># ruv</span>
varPart.ad.ruv &lt;-<span class="st"> </span><span class="kw">fitExtractVarPartModel</span>(<span class="kw">t</span>(ad.ruvIII), form.ad, info.ad)


################
<span class="co">#merge them</span>
variance.ad =<span class="st">  </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.before<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.before<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.bmc<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.bmc<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.combat<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.combat<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.limma<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.limma<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.percentile<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.percentile<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.svd<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.svd<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>,<span class="dv">231</span>)), <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.ruv<span class="op">$</span>ad.batch,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Batch&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;RUVIII&#39;</span>,<span class="dv">231</span>)),
                             <span class="kw">cbind</span>(<span class="dt">variance =</span> varPart.ad.ruv<span class="op">$</span>ad.trt,<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="dv">231</span>), <span class="dt">method =</span> <span class="kw">rep</span>(<span class="st">&#39;RUVIII&#39;</span>,<span class="dv">231</span>)))

variance.ad =<span class="st"> </span><span class="kw">as.data.frame</span>(variance.ad)
variance.ad<span class="op">$</span>Type =<span class="st"> </span><span class="kw">factor</span>(variance.ad<span class="op">$</span>Type,<span class="dt">levels =</span> <span class="kw">unique</span>(variance.ad<span class="op">$</span>Type))
variance.ad<span class="op">$</span>method =<span class="st"> </span><span class="kw">factor</span>(variance.ad<span class="op">$</span>method,<span class="dt">levels =</span> <span class="kw">unique</span>(variance.ad<span class="op">$</span>method))
variance.ad<span class="op">$</span>variance =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(variance.ad<span class="op">$</span>variance))

<span class="kw">ggplot</span>(variance.ad, <span class="kw">aes</span>(<span class="dt">x=</span>Type, <span class="dt">y=</span>variance,<span class="dt">fill=</span>Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(<span class="dt">cols =</span> <span class="kw">vars</span>(method)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">11</span>),<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Type&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion Variance&quot;</span>,<span class="dt">name=</span><span class="st">&#39;Type&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_hue</span>(<span class="dt">l=</span><span class="dv">40</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-60-2.png" width="672" /></p>
</div>
<div id="rda" class="section level3">
<h3><span class="header-section-number">4.2.2</span> RDA</h3>
<p>The multivariate method pRDA can be applied to calculate the variance of batch and treatment effects for all variables at once.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Sponge data</span>
sponge.data.design =<span class="st"> </span><span class="kw">numeric</span>()
sponge.data.design<span class="op">$</span>group =<span class="st"> </span>sponge.trt
sponge.data.design<span class="op">$</span>batch =<span class="st"> </span>sponge.batch

<span class="co"># before</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.before1 =<span class="st"> </span><span class="kw">rda</span>(sponge.tss.clr <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.before2 =<span class="st"> </span><span class="kw">rda</span>(sponge.tss.clr <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.before =<span class="st"> </span>sponge.rda.before1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.before1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.before =<span class="st"> </span>sponge.rda.before2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.before2<span class="op">$</span>tot.chi

<span class="co"># BMC</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.bmc1 =<span class="st"> </span><span class="kw">rda</span>(sponge.bmc <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.bmc2 =<span class="st"> </span><span class="kw">rda</span>(sponge.bmc <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.bmc =<span class="st"> </span>sponge.rda.bmc1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.bmc1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.bmc =<span class="st"> </span>sponge.rda.bmc2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.bmc2<span class="op">$</span>tot.chi


<span class="co"># combat</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.combat1 =<span class="st"> </span><span class="kw">rda</span>(sponge.combat <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.combat2 =<span class="st"> </span><span class="kw">rda</span>(sponge.combat <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.combat =<span class="st"> </span>sponge.rda.combat1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.combat1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.combat =<span class="st"> </span>sponge.rda.combat2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.combat2<span class="op">$</span>tot.chi


<span class="co"># limma</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.limma1 =<span class="st"> </span><span class="kw">rda</span>(sponge.limma <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.limma2 =<span class="st"> </span><span class="kw">rda</span>(sponge.limma <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.limma =<span class="st"> </span>sponge.rda.limma1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.limma1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.limma =<span class="st"> </span>sponge.rda.limma2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.limma2<span class="op">$</span>tot.chi


<span class="co"># percentile</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.percentile1 =<span class="st"> </span><span class="kw">rda</span>(sponge.percentile <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.percentile2 =<span class="st"> </span><span class="kw">rda</span>(sponge.percentile <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.percentile =<span class="st"> </span>sponge.rda.percentile1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.percentile1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.percentile =<span class="st"> </span>sponge.rda.percentile2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.percentile2<span class="op">$</span>tot.chi


<span class="co"># SVD</span>
<span class="co"># conditioning on a batch effect</span>
sponge.rda.svd1 =<span class="st"> </span><span class="kw">rda</span>(sponge.svd <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> sponge.data.design)
sponge.rda.svd2 =<span class="st"> </span><span class="kw">rda</span>(sponge.svd <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> sponge.data.design)

<span class="co"># amount of variance</span>
sponge.rda.bat_prop.svd =<span class="st"> </span>sponge.rda.svd1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.svd1<span class="op">$</span>tot.chi
sponge.rda.trt_prop.svd =<span class="st"> </span>sponge.rda.svd2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>sponge.rda.svd2<span class="op">$</span>tot.chi</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># proportion</span>
sponge.rda.prop.before =<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.before,sponge.rda.trt_prop.before)
sponge.rda.prop.bmc =<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.bmc,sponge.rda.trt_prop.bmc)
sponge.rda.prop.combat =<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.combat,sponge.rda.trt_prop.combat)
sponge.rda.prop.limma =<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.limma,sponge.rda.trt_prop.limma)
sponge.rda.prop.percentile =<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.percentile,sponge.rda.trt_prop.percentile)
sponge.rda.prop.svd=<span class="st"> </span><span class="kw">c</span>(sponge.rda.bat_prop.svd,sponge.rda.trt_prop.svd)

sponge.rda.prop.val =<span class="st"> </span><span class="kw">c</span>(sponge.rda.prop.before,sponge.rda.prop.bmc,sponge.rda.prop.combat,sponge.rda.prop.limma,sponge.rda.prop.percentile,sponge.rda.prop.svd)
sponge.rda.prop =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prop =</span> sponge.rda.prop.val, <span class="dt">prop.r =</span> <span class="kw">round</span>(sponge.rda.prop.val,<span class="dv">2</span>), <span class="dt">Method =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Before&#39;</span>,<span class="st">&#39;BMC&#39;</span>,<span class="st">&#39;ComBat&#39;</span>,<span class="st">&#39;rBE&#39;</span>,<span class="st">&#39;PN&#39;</span>,<span class="st">&#39;SVD&#39;</span>),<span class="dt">each=</span><span class="dv">2</span>),<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Tissue&#39;</span>),<span class="dv">6</span>))

sponge.rda.prop<span class="op">$</span>Method =<span class="st">  </span><span class="kw">factor</span>(sponge.rda.prop<span class="op">$</span>Method, <span class="dt">levels =</span> <span class="kw">unique</span>(sponge.rda.prop<span class="op">$</span>Method))

<span class="kw">ggplot</span>(<span class="dt">data =</span> sponge.rda.prop, <span class="kw">aes</span>(<span class="dt">x=</span>Method,<span class="dt">y=</span>prop,<span class="dt">fill =</span> Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>,<span class="dt">position =</span> <span class="st">&#39;dodge&#39;</span>, <span class="dt">colour =</span> <span class="st">&#39;black&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="dt">data=</span>sponge.rda.prop, <span class="kw">aes</span>(Method, prop<span class="op">+</span><span class="fl">2.5</span>, <span class="dt">label=</span>prop.r), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Variance explained (%)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">100</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-62-1.png" width="672" /></p>
<p>pRDA shows that BMC, ComBat and removeBatchEffect were more efficient at removing batch variation while preserving treatment variation. This result is in agreement with the proportional variance calculated using a linear model in the previous section `linear model per variable’. ComBat removed relatively less batch variation compared with the other two methods, which implies that the batch effect is not purely systematic. The low efficiency of percentile normalisation is more obvious in the variance calculated with pRDA. It did not remove enough batch variation, nor preserve enough treatment variation both in sponge data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># AD data</span>
data.design.ad =<span class="st"> </span><span class="kw">numeric</span>()
data.design.ad<span class="op">$</span>group =<span class="st"> </span>ad.trt
data.design.ad<span class="op">$</span>batch =<span class="st"> </span>ad.batch

<span class="co"># before</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.before1 =<span class="st"> </span><span class="kw">rda</span>(ad.tss.clr <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.before2 =<span class="st"> </span><span class="kw">rda</span>(ad.tss.clr <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.before =<span class="st"> </span>rda.ad.before1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.before1<span class="op">$</span>tot.chi
rda.prop.trt.ad.before =<span class="st"> </span>rda.ad.before2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.before1<span class="op">$</span>tot.chi

<span class="co"># BMC</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.bmc1 =<span class="st"> </span><span class="kw">rda</span>(ad.bmc <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.bmc2 =<span class="st"> </span><span class="kw">rda</span>(ad.bmc <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.bmc =<span class="st"> </span>rda.ad.bmc1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.bmc1<span class="op">$</span>tot.chi
rda.prop.trt.ad.bmc =<span class="st"> </span>rda.ad.bmc2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.bmc2<span class="op">$</span>tot.chi


<span class="co"># combat</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.combat1 =<span class="st"> </span><span class="kw">rda</span>(ad.combat <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.combat2 =<span class="st"> </span><span class="kw">rda</span>(ad.combat <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.combat =<span class="st"> </span>rda.ad.combat1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.combat1<span class="op">$</span>tot.chi
rda.prop.trt.ad.combat =<span class="st"> </span>rda.ad.combat2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.combat2<span class="op">$</span>tot.chi


<span class="co"># limma</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.limma1 =<span class="st"> </span><span class="kw">rda</span>(ad.limma <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.limma2 =<span class="st"> </span><span class="kw">rda</span>(ad.limma <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.limma =<span class="st"> </span>rda.ad.limma1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.limma1<span class="op">$</span>tot.chi
rda.prop.trt.ad.limma =<span class="st"> </span>rda.ad.limma2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.limma2<span class="op">$</span>tot.chi


<span class="co"># percentile</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.percentile1 =<span class="st"> </span><span class="kw">rda</span>(ad.percentile <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.percentile2 =<span class="st"> </span><span class="kw">rda</span>(ad.percentile <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.percentile =<span class="st"> </span>rda.ad.percentile1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.percentile1<span class="op">$</span>tot.chi
rda.prop.trt.ad.percentile =<span class="st"> </span>rda.ad.percentile2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.percentile2<span class="op">$</span>tot.chi


<span class="co"># SVD</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.svd1 =<span class="st"> </span><span class="kw">rda</span>(ad.svd <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.svd2 =<span class="st"> </span><span class="kw">rda</span>(ad.svd <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.svd =<span class="st"> </span>rda.ad.svd1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.svd1<span class="op">$</span>tot.chi
rda.prop.trt.ad.svd =<span class="st"> </span>rda.ad.svd2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.svd2<span class="op">$</span>tot.chi


<span class="co"># RUVIII</span>
<span class="co"># conditioning on a batch effect</span>
rda.ad.ruv1 =<span class="st"> </span><span class="kw">rda</span>(ad.ruvIII <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(batch), <span class="dt">data =</span> data.design.ad)
rda.ad.ruv2 =<span class="st"> </span><span class="kw">rda</span>(ad.ruvIII <span class="op">~</span><span class="st"> </span>batch <span class="op">+</span><span class="st"> </span><span class="kw">Condition</span>(group), <span class="dt">data =</span> data.design.ad)

<span class="co"># amount of variance</span>
rda.prop.bat.ad.ruv =<span class="st"> </span>rda.ad.ruv1<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.ruv1<span class="op">$</span>tot.chi
rda.prop.trt.ad.ruv =<span class="st"> </span>rda.ad.ruv2<span class="op">$</span>pCCA<span class="op">$</span>tot.chi<span class="op">*</span><span class="dv">100</span><span class="op">/</span>rda.ad.ruv2<span class="op">$</span>tot.chi</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># proportion</span>
rda.prop.ad.before =<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.before,rda.prop.trt.ad.before)
rda.prop.ad.bmc =<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.bmc,rda.prop.trt.ad.bmc)
rda.prop.ad.combat =<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.combat,rda.prop.trt.ad.combat)
rda.prop.ad.limma =<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.limma,rda.prop.trt.ad.limma)
rda.prop.ad.percentile =<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.percentile,rda.prop.trt.ad.percentile)
rda.prop.ad.svd=<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.svd,rda.prop.trt.ad.svd)
rda.prop.ad.ruv=<span class="st"> </span><span class="kw">c</span>(rda.prop.bat.ad.ruv,rda.prop.trt.ad.ruv)

#############
rda.prop.ad.val =<span class="st"> </span><span class="kw">c</span>(rda.prop.ad.before,rda.prop.ad.bmc,rda.prop.ad.combat,rda.prop.ad.limma,rda.prop.ad.percentile,rda.prop.ad.svd,rda.prop.ad.ruv)
rda.prop.ad =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prop =</span> rda.prop.ad.val, <span class="dt">prop.r =</span> <span class="kw">round</span>(rda.prop.ad.val,<span class="dv">2</span>), <span class="dt">Method =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Before&#39;</span>,<span class="st">&#39;BMC&#39;</span>,<span class="st">&#39;ComBat&#39;</span>,<span class="st">&#39;rBE&#39;</span>,<span class="st">&#39;PN&#39;</span>,<span class="st">&#39;SVD&#39;</span>,<span class="st">&#39;RUVIII&#39;</span>),<span class="dt">each=</span><span class="dv">2</span>),<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>),<span class="dv">7</span>))

rda.prop.ad<span class="op">$</span>Method =<span class="st">  </span><span class="kw">factor</span>(rda.prop.ad<span class="op">$</span>Method, <span class="dt">levels =</span> <span class="kw">unique</span>(rda.prop.ad<span class="op">$</span>Method))

<span class="kw">ggplot</span>(<span class="dt">data =</span> rda.prop.ad, <span class="kw">aes</span>(<span class="dt">x=</span>Method,<span class="dt">y=</span>prop,<span class="dt">fill =</span> Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>,<span class="dt">position =</span> <span class="st">&#39;dodge&#39;</span>, <span class="dt">colour =</span> <span class="st">&#39;black&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="dt">data=</span>rda.prop.ad, <span class="kw">aes</span>(Method, prop<span class="op">+</span><span class="fl">2.5</span>, <span class="dt">label=</span>prop.r), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="dv">1</span>), <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Variance explained (%)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_hue</span>(<span class="dt">l=</span><span class="dv">40</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">100</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
</div>
<div id="pvca" class="section level3">
<h3><span class="header-section-number">4.2.3</span> PVCA</h3>
<p>It does not work for dataset with only 24 samples, therefore it cannot be applied on Sponge data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># AD data</span>
PVCA.score.ad =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Interaction =</span> <span class="ot">NA</span>, <span class="dt">Batch =</span> <span class="ot">NA</span>,<span class="dt">Treatment =</span> <span class="ot">NA</span>,<span class="dt">Residuals =</span> <span class="ot">NA</span>)

Bat_Int.factors =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Batch =</span> ad.batch, <span class="dt">Treatment =</span> ad.trt)
<span class="kw">rownames</span>(Bat_Int.factors) =<span class="st"> </span><span class="kw">rownames</span>(ad.tss.clr)
pdata &lt;-<span class="st"> </span><span class="kw">AnnotatedDataFrame</span>(Bat_Int.factors)

<span class="co"># before</span>
eset.X.before &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.tss.clr), <span class="dt">phenoData =</span> pdata)
pvcaObj.before &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.before, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.before =<span class="st"> </span>pvcaObj.before<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">1</span>,] =<span class="st"> </span>values.before

<span class="co"># bmc</span>
eset.X.bmc &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.bmc), <span class="dt">phenoData =</span> pdata)
pvcaObj.bmc &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.bmc, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.bmc =<span class="st"> </span>pvcaObj.bmc<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">2</span>,] =<span class="st"> </span>values.bmc


<span class="co"># combat</span>

eset.X.combat &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.combat), <span class="dt">phenoData =</span> pdata)
pvcaObj.combat &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.combat, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.combat =<span class="st"> </span>pvcaObj.combat<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">3</span>,] =<span class="st"> </span>values.combat

<span class="co"># PN</span>

eset.X.percentile &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.percentile), <span class="dt">phenoData =</span> pdata)
pvcaObj.percentile &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.percentile, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.percentile =<span class="st"> </span>pvcaObj.percentile<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">5</span>,] =<span class="st"> </span>values.percentile


<span class="co"># limma</span>

eset.X.limma &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.limma), <span class="dt">phenoData =</span> pdata)
pvcaObj.limma &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.limma, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.limma =<span class="st"> </span>pvcaObj.limma<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">4</span>,] =<span class="st"> </span>values.limma



<span class="co"># svd</span>

eset.X.svd &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.svd), <span class="dt">phenoData =</span> pdata)
pvcaObj.svd &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.svd, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.svd =<span class="st"> </span>pvcaObj.svd<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">6</span>,] =<span class="st"> </span>values.svd


<span class="co"># RUVIII</span>

eset.X.ruv &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;ExpressionSet&quot;</span>, <span class="dt">exprs =</span> <span class="kw">t</span>(ad.ruvIII), <span class="dt">phenoData =</span> pdata)
pvcaObj.ruv &lt;-<span class="st"> </span><span class="kw">pvcaBatchAssess</span>(eset.X.ruv, <span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>), <span class="fl">0.6</span>)
values.ruv =<span class="st"> </span>pvcaObj.ruv<span class="op">$</span>dat
PVCA.score.ad[<span class="dv">7</span>,] =<span class="st"> </span>values.ruv

<span class="kw">rownames</span>(PVCA.score.ad) =<span class="kw">c</span>(<span class="st">&#39;Before&#39;</span>,<span class="st">&#39;BMC&#39;</span>,<span class="st">&#39;ComBat&#39;</span>,<span class="st">&#39;rBE&#39;</span>,<span class="st">&#39;PN&#39;</span>,<span class="st">&#39;SVD&#39;</span>,<span class="st">&#39;RUVIII&#39;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#############
pvca.prop.ad.val =<span class="st"> </span><span class="kw">c</span>(PVCA.score.ad<span class="op">$</span>Batch,PVCA.score.ad<span class="op">$</span>Treatment)
pvca.prop.ad =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prop =</span> pvca.prop.ad.val, <span class="dt">prop.r =</span> <span class="kw">round</span>(pvca.prop.ad.val,<span class="dv">2</span>), <span class="dt">Method =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Before&#39;</span>,<span class="st">&#39;BMC&#39;</span>,<span class="st">&#39;ComBat&#39;</span>,<span class="st">&#39;rBE&#39;</span>,<span class="st">&#39;PN&#39;</span>,<span class="st">&#39;SVD&#39;</span>,<span class="st">&#39;RUVIII&#39;</span>),<span class="dv">2</span>),<span class="dt">Type =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&#39;Batch&#39;</span>,<span class="st">&#39;Treatment&#39;</span>),<span class="dt">each =</span> <span class="dv">7</span>))

pvca.prop.ad<span class="op">$</span>Method =<span class="st">  </span><span class="kw">factor</span>(pvca.prop.ad<span class="op">$</span>Method, <span class="dt">levels =</span> <span class="kw">unique</span>(pvca.prop.ad<span class="op">$</span>Method))

<span class="kw">ggplot</span>(<span class="dt">data =</span> pvca.prop.ad, <span class="kw">aes</span>(<span class="dt">x=</span>Method,<span class="dt">y=</span>prop,<span class="dt">fill =</span> Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>,<span class="dt">position =</span> <span class="st">&#39;dodge&#39;</span>,<span class="dt">colour =</span> <span class="st">&#39;black&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="dt">data=</span>pvca.prop.ad, <span class="kw">aes</span>(Method, prop<span class="op">+</span><span class="fl">0.03</span>, <span class="dt">label=</span>prop.r), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Weighted average proportion variance&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_hue</span>(<span class="dt">l=</span><span class="dv">40</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-66-1.png" width="672" /></p>
</div>
<div id="silhouette-coefficient" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Silhouette coefficient</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">###################
<span class="co"># Sponge data</span>

silh.sponge.before =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.before<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)
silh.sponge.bmc =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.bmc<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)
silh.sponge.combat =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.combat<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)
silh.sponge.limma =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.limma<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)
silh.sponge.percentile =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.percentile<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)
silh.sponge.svd =<span class="st"> </span><span class="kw">calc.sil</span>(sponge.pca.svd<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> sponge.batch, <span class="dt">y2=</span> sponge.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Tissue&#39;</span>)


data.plot.sponge =<span class="st"> </span><span class="kw">rbind</span>(silh.sponge.before, silh.sponge.bmc, silh.sponge.combat, silh.sponge.limma, silh.sponge.percentile, silh.sponge.svd)
data.plot.sponge<span class="op">$</span>method =<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>, <span class="kw">nrow</span>(silh.sponge.before)), 
                            <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>, <span class="kw">nrow</span>(silh.sponge.bmc)),
                            <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>, <span class="kw">nrow</span>(silh.sponge.combat)),
                            <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>, <span class="kw">nrow</span>(silh.sponge.limma)),
                            <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>, <span class="kw">nrow</span>(silh.sponge.percentile)),
                            <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>, <span class="kw">nrow</span>(silh.sponge.svd))
)
data.plot.sponge<span class="op">$</span>method =<span class="st"> </span><span class="kw">factor</span>(data.plot.sponge<span class="op">$</span>method,<span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.sponge<span class="op">$</span>method))
data.plot.sponge<span class="op">$</span>Cluster =<span class="st">  </span><span class="kw">factor</span>(data.plot.sponge<span class="op">$</span>Cluster, <span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.sponge<span class="op">$</span>Cluster))
data.plot.sponge<span class="op">$</span>Type =<span class="st">  </span><span class="kw">factor</span>(data.plot.sponge<span class="op">$</span>Type, <span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.sponge<span class="op">$</span>Type))


<span class="kw">ggplot</span>(data.plot.sponge, <span class="kw">aes</span>(<span class="dt">x=</span>Type, <span class="dt">y=</span>silh.coeff, <span class="dt">color =</span> Cluster, <span class="dt">shape =</span> Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(<span class="dt">cols =</span> <span class="kw">vars</span>(method)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#388ECC&quot;</span>,<span class="st">&quot;#F68B33&quot;</span>,<span class="st">&quot;#F0E442&quot;</span>,<span class="st">&quot;#D55E00&quot;</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Type&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Silhouette Coefficient&quot;</span>, <span class="dt">name=</span><span class="st">&quot;Type&quot;</span>) </code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-67-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">############
<span class="co"># AD data</span>
silh.ad.before =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.before<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.bmc =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.bmc<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.combat =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.combat<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.limma =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.limma<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.percentile =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.percentile<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.svd =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.svd<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)
silh.ad.ruv =<span class="st"> </span><span class="kw">calc.sil</span>(ad.pca.ruv<span class="op">$</span>variates<span class="op">$</span>X,<span class="dt">y1 =</span> ad.batch, <span class="dt">y2=</span> ad.trt, <span class="dt">name.y1 =</span> <span class="st">&#39;Batch&#39;</span>,<span class="dt">name.y2 =</span> <span class="st">&#39;Treatment&#39;</span>)


data.plot.ad =<span class="st"> </span><span class="kw">rbind</span>(silh.ad.before, silh.ad.bmc, silh.ad.combat, silh.ad.limma, silh.ad.percentile, silh.ad.svd,silh.ad.ruv)
data.plot.ad<span class="op">$</span>method =<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&#39;Before&#39;</span>, <span class="kw">nrow</span>(silh.ad.before)), 
                            <span class="kw">rep</span>(<span class="st">&#39;BMC&#39;</span>, <span class="kw">nrow</span>(silh.ad.bmc)),
                            <span class="kw">rep</span>(<span class="st">&#39;ComBat&#39;</span>, <span class="kw">nrow</span>(silh.ad.combat)),
                            <span class="kw">rep</span>(<span class="st">&#39;rBE&#39;</span>, <span class="kw">nrow</span>(silh.ad.limma)),
                            <span class="kw">rep</span>(<span class="st">&#39;PN&#39;</span>, <span class="kw">nrow</span>(silh.ad.percentile)),
                            <span class="kw">rep</span>(<span class="st">&#39;SVD&#39;</span>, <span class="kw">nrow</span>(silh.ad.svd)),
                        <span class="kw">rep</span>(<span class="st">&#39;RUVIII&#39;</span>, <span class="kw">nrow</span>(silh.ad.ruv))
)
data.plot.ad<span class="op">$</span>method =<span class="st"> </span><span class="kw">factor</span>(data.plot.ad<span class="op">$</span>method, <span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.ad<span class="op">$</span>method))
data.plot.ad<span class="op">$</span>Cluster =<span class="st">  </span><span class="kw">factor</span>(data.plot.ad<span class="op">$</span>Cluster, <span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.ad<span class="op">$</span>Cluster))
data.plot.ad<span class="op">$</span>Type =<span class="st">  </span><span class="kw">factor</span>(data.plot.ad<span class="op">$</span>Type, <span class="dt">levels =</span> <span class="kw">unique</span>(data.plot.ad<span class="op">$</span>Type))

<span class="kw">ggplot</span>(data.plot.ad, <span class="kw">aes</span>(<span class="dt">x=</span>Type, <span class="dt">y=</span>silh.coeff, <span class="dt">color =</span> Cluster, <span class="dt">shape =</span> Type)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(<span class="dt">cols =</span> <span class="kw">vars</span>(method)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">60</span>, <span class="dt">hjust =</span> <span class="dv">1</span>), <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),<span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">10</span>),<span class="dt">axis.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">15</span>),<span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;#388ECC&quot;</span>, <span class="st">&quot;#F68B33&quot;</span>, <span class="st">&quot;#C2C2C2&quot;</span>, <span class="st">&quot;#009E73&quot;</span>, <span class="st">&quot;#CC79A7&quot;</span>,<span class="st">&quot;#0072B2&quot;</span>, <span class="st">&quot;#999999&quot;</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Type&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Silhouette Coefficient&quot;</span>, <span class="dt">name=</span><span class="st">&quot;Type&quot;</span>) </code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-67-2.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="adjust.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="simu.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["vignette.pdf"],
"toc": {
"collapse": "subsection",
"edit": "https://github.com/EvaYiwenWang/vignette"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
